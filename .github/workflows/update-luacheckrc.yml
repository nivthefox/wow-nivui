name: Update luacheckrc

on:
  schedule:
    # Run monthly on the 1st at 00:00 UTC
    - cron: '0 0 1 * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download latest luacheckrc
        run: |
          # Get the latest release tag
          RELEASE=$(curl -s https://api.github.com/repos/LiangYuxuan/wow-addon-luacheckrc/releases/latest | grep '"tag_name"' | sed -E 's/.*"([^"]+)".*/\1/')
          echo "Latest release: $RELEASE"

          # Download the default (retail) luacheckrc
          curl -sL "https://github.com/LiangYuxuan/wow-addon-luacheckrc/releases/download/${RELEASE}/default.luacheckrc" -o upstream.luacheckrc

      - name: Merge with addon globals
        run: |
          # Extract our custom sections from current .luacheckrc
          # Keep lines 24-32 (globals block) and lines 34-38 (Midnight APIs)

          # Take header from upstream (lines 1-23)
          head -23 upstream.luacheckrc > .luacheckrc.new

          # Add our globals block
          cat >> .luacheckrc.new << 'EOF'
          globals = {
          	-- NivUI addon globals
          	"NivUI",
          	"NivUIDB",
          	"NivUICharDB",
          	"NivUIConfigFrame",
          	"NivUI_DB",
          	"NivUI_StaggerBarDB",
          }
          read_globals = {
          	-- WoW 12.0 Midnight APIs (not yet in upstream luacheckrc)
          	"issecretvalue",
          	"UnitHealthPercent",
          	"UnitPowerPercent",

          EOF

          # Append rest of upstream read_globals (skip first line "read_globals = {")
          tail -n +25 upstream.luacheckrc >> .luacheckrc.new

          mv .luacheckrc.new .luacheckrc
          rm upstream.luacheckrc

      - name: Verify luacheck config
        run: |
          # Just check syntax by running luacheck --help with the config
          lua5.1 -e "dofile('.luacheckrc')" || exit 1
          echo "Config syntax OK"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: update luacheckrc from upstream"
          title: "chore: update luacheckrc from upstream"
          body: |
            Automated monthly update of `.luacheckrc` from [LiangYuxuan/wow-addon-luacheckrc](https://github.com/LiangYuxuan/wow-addon-luacheckrc).

            This PR updates the WoW API globals while preserving NivUI-specific configuration.
          branch: update-luacheckrc
          delete-branch: true
